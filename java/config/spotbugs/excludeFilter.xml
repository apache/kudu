<?xml version="1.0"?>
<!--
//
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
-->
<FindBugsFilter>
    <!-- General exclusions -->
    <Match>
        <!-- Ignore classes generated by Protobuf.
        Unfortunately I couldn't find a way to universally filter all Protobuf classes. -->
        <Or>
            <Class name="~.*PB.*"/>
            <Class name="~org\.apache\.kudu\.consensus\.Opid.*"/>
            <Class name="~org\.apache\.kudu\.master\.Master.*"/>
            <Class name="~org\.apache\.kudu\.rpc\.RpcHeader.*"/>
        </Or>
    </Match>
    <Match>
        <!-- Spotbugs works better with Java than with Scala. We suppress some categories of
        bug reports when using Scala, since spotbugs generates huge numbers of false positives
        when examining Scala code. -->
         <Source name="~.*\.scala" />
         <Or>
             <!-- NP_LOAD_OF_KNOWN_NULL_VALUE: The variable referenced at this point is known to be
              null due to an earlier check against null. -->
             <Bug pattern="NP_LOAD_OF_KNOWN_NULL_VALUE"/>
             <!-- NP_NULL_ON_SOME_PATH: Possible null pointer dereference. -->
             <Bug pattern="NP_NULL_ON_SOME_PATH"/>
             <!-- NP_NULL_PARAM_DEREF: Method call passes null for non-null parameter. -->
             <Bug pattern="NP_NULL_PARAM_DEREF"/>
             <!-- SE_BAD_FIELD: Non-transient non-serializable instance field in serializable class. -->
             <Bug pattern="SE_BAD_FIELD"/>
             <!-- SE_BAD_FIELD_STORE: Non-serializable value stored into instance field of a serializable class. -->
             <Bug pattern="SE_BAD_FIELD_STORE"/>
             <!-- DM_STRING_CTOR: Method invokes inefficient new String(String) constructor. -->
             <Bug pattern="DM_STRING_CTOR"/>
             <!-- DM_NEW_FOR_GETCLASS: Method allocates an object, only to get the class object. -->
             <Bug pattern="DM_NEW_FOR_GETCLASS"/>
             <!-- ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD: Write to static field from instance method. -->
             <Bug pattern="ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD"/>
             <!-- DM_NUMBER_CTOR: Method invokes inefficient Number constructor. -->
             <Bug pattern="DM_NUMBER_CTOR"/>
             <!-- RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE: Nullcheck of value previously dereferenced. -->
             <Bug pattern="RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE"/>
             <!-- RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE: Redundant nullcheck of value known to be non-null. -->
             <Bug pattern="RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE"/>
             <!-- RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE: Redundant nullcheck of value known to be null. -->
             <Bug pattern="RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE"/>
             <!-- RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT: Return value of method without side effect is ignored. -->
             <Bug pattern="RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT"/>
             <!-- NM_CLASS_NAMING_CONVENTION: Class names should start with an upper case letter. -->
             <Bug pattern="NM_CLASS_NAMING_CONVENTION"/>
             <!-- NM_METHOD_NAMING_CONVENTION: Method names should start with a lower case letter. -->
             <Bug pattern="NM_METHOD_NAMING_CONVENTION"/>
             <!-- EC_NULL_ARG: Call to equals(null) -->
             <Bug pattern="EC_NULL_ARG"/>
             <!-- NP_ALWAYS_NULL: Null pointer dereference -->
             <Bug pattern="NP_ALWAYS_NULL"/>
             <!-- MS_CANNOT_BE_FINAL: Field isn't final and can't be protected from malicious code. -->
             <Bug pattern="MS_CANNOT_BE_FINAL"/>
         </Or>
    </Match>
    <Match>
        <!-- The retry rule doesn't need to be read.
        This naming scheme should be used for all RetryRule usage to avoid SpotBugs issues.
        -->
        <Field name="~.*retryRule" />
        <Bug pattern="URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD" />
    </Match>
    <Match>
        <!-- Disable warnings about mutable objects and the use of public fields.
         Though these are important concerns, we have many instances of this warning
         and "fixing" the warning could have performance implications. -->
        <Bug pattern="EI_EXPOSE_REP,EI_EXPOSE_REP2" />
    </Match>
    <Match>
        <!-- This rule often falsely flags side effecting calls. Tests will frequently call
        methods for the side effects without caring about the return value. -->
        <Class name="~org\.apache\.kudu.*Test.*"/>
        <Bug pattern="RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT" />
    </Match>
    <Match>
        <!-- Tests use i % 2 == 1 frequently to alternate behavior. -->
        <!-- TODO: converting these into negated "check for even" and remove. -->
        <Class name="~org\.apache\.kudu.*Test.*"/>
        <Bug pattern="IM_BAD_CHECK_FOR_ODD" />
    </Match>

    <!-- kudu-backup exclusions -->
    <Match>
        <!-- The options field doesn't need to be restored in this case. -->
        <Class name="org.apache.kudu.backup.KuduBackupRDD"/>
        <Field name="options" />
        <Bug pattern="SE_TRANSIENT_FIELD_NOT_RESTORED" />
    </Match>

    <!-- kudu-client exclusions -->
    <Match>
        <!-- Reference equality is intended here. -->
        <Class name="org.apache.kudu.client.AsyncKuduClient"/>
        <Method name="isMasterTable" />
        <Bug pattern="ES_COMPARING_PARAMETER_STRING_WITH_EQ" />
    </Match>
    <Match>
        <!-- These classes have exception in the name because they hold an exception. -->
        <Or>
            <Class name="org.apache.kudu.client.AuthzTokenCache$RpcAndException"/>
            <Class name="org.apache.kudu.client.KuduException$OriginalException"/>
        </Or>
        <Bug pattern="NM_CLASS_NOT_EXCEPTION" />
    </Match>

    <Match>
        <!-- The nullable annotation is from Guava and therefore can't be changed.
        Guava is adding `@Nullable` on the parent `apply` method from the guava Predicate
        implementation for `gtePred` and `ltPred` and that's being detected by SpotBugs for
        some reason.
        -->
        <Class name="~org\.apache\.kudu\.client\.TestFlexiblePartitioning.*"/>
        <Bug pattern="NP_PARAMETER_MUST_BE_NONNULL_BUT_MARKED_AS_NULLABLE" />
    </Match>
    <Match>
        <!-- Adjusts AsyncKuduClient.FETCH_TABLETS_PER_RANGE_LOOKUP for testing purposes.  -->
        <Class name="org.apache.kudu.client.TestScanToken"/>
        <Method name="testScanTokens" />
        <Bug pattern="ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD" />
    </Match>
    <Match>
        <!-- Adjusts TableLocationsCache.ticker for testing purposes.  -->
        <Class name="org.apache.kudu.client.TestTableLocationsCache"/>
        <Bug pattern="ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD" />
    </Match>

    <!-- kudu-client-tools exclusions -->
    <Match>
        <!-- The rule doesn't need to be read. -->
        <Class name="org.apache.kudu.mapreduce.tools.ITImportParquetPreCheck"/>
        <Field name="chain" />
        <Bug pattern="URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD" />
    </Match>

    <!-- kudu-spark exclusions -->
    <Match>
        <!-- The options and projectedCols field doesn't need to be restored in this case. -->
        <Class name="org.apache.kudu.spark.kudu.KuduRDD"/>
        <Or>
            <Field name="options" />
            <Field name="projectedCols"/>
        </Or>
        <Bug pattern="SE_TRANSIENT_FIELD_NOT_RESTORED" />
    </Match>

    <!-- kudu-test-utils exclusions -->
    <Match>
        <!-- There is nothing useful to do with the File.delete() return value. -->
        <Class name="org.apache.kudu.test.CapturingToFileLogAppender"/>
        <Bug pattern="RV_RETURN_VALUE_IGNORED_BAD_PRACTICE" />
    </Match>
    <Match>
        <!-- This is a mock for a test and doesn't need to be serialized. -->
        <Class name="org.apache.kudu.test.junit.TestResultReporter$MockFlakyTestServlet"/>
        <Bug pattern="SE_TRANSIENT_FIELD_NOT_RESTORED" />
    </Match>
</FindBugsFilter>